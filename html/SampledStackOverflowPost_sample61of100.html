Answered posted on: 2015-10-01 17:46:27+00:00
<a<p>Assuming the <a href="http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/sys_socket.h.html" rel="nofollow">POSIX sockets (IEEE Std 1003.1, 2013 Edition)</a> are used.</p>

<h1>Analysis</h1>

<p>Let's consider the following pieces of code:</p>

<ol>
<li><p>Sending the file size.</p>

<pre><code>// Sending the file size to the Windows Client  
iResult = send(client[iD].socket, (const char*)&amp;Size_Send, sizeof(long), 0);
if (iResult &lt;= 0)
{
      errno_message.append((char*)strerror(errno));
      FUNCTION_LOG(errno_message);
      return 1;
}
</code></pre></li>
<li><p>Sending the "block".</p>

<pre><code>if (send(client[iD].socket, Block, BytesRead, 0) != BytesRead)
{
    errno_message.append((char*)strerror(errno));
    FUNCTION_LOG(errno_message);
    fclose(fp);
    return 1;
}
</code></pre></li>
</ol>

<p>The <code>send()</code> function does not guarantee that all the data will be sent "at once" (i.e. with the single function call):</p>

<blockquote>
  <h2>Return value</h2>
  
  <p>Upon successful completion, <code>send()</code> shall return the number of bytes sent. Otherwise, -1 shall be returned and <code>errno</code> set to indicate the error.</p>
  
  <p>â€” <a href="http://pubs.opengroup.org/onlinepubs/9699919799/" rel="nofollow">send - send a message on a socket, The Open Group Base Specifications Issue 7, IEEE Std 1003.1, 2013 Edition</a>.</p>
</blockquote>

<p>As a result, the <code>if (send(client[iD].socket, Block, BytesRead, 0) != BytesRead)</code> check does not seem to be right.</p>

<h1>Solution</h1>

<p>The return value of the <code>send()</code> function must be used to implement the loop to send all the bytes read previously by the <code>fread()</code> function call.
Please see the implementation of the <code>SendAllBytes()</code> function. It should be used to correct the both pieces of code (see the "Analysis" section).</p>

<p>The following code should be considered only as an example:</p>

<pre><code>#include &lt;stdio.h&gt;
#include &lt;sys/socket.h&gt;

...

if (SendAllBytes(socket, &amp;file_size, sizeof(file_size)) != 0) {
    // Error.
    return;
}

...

char buffer[1024];
while (feof(file_stream) == 0) {
    const size_t bytes_read = fread(buffer, sizeof(*buffer), sizeof(buffer) / sizeof(*buffer), file_stream);
    // Upon successful completion, fread() shall return the number of elements
    // successfully read which is less than nitems only if a read error or end-of-file is encountered.
    // If size or nitems is 0, fread() shall return 0 and the contents of the array and the state of the stream remain unchanged.
    // Otherwise, if a read error occurs, the error indicator for the stream shall be set, and errno shall be set to indicate the error.
    // (Source: http://pubs.opengroup.org/onlinepubs/9699919799/functions/fread.html).
    if (bytes_read &lt; sizeof(buffer) / sizeof(*buffer) &amp;&amp;
        ferror(file_stream) != 0) {
        // Error.
        return;
    }

    if (SendAllBytes(socket, buffer, bytes_read) != 0) {
        // Error.
        return;
    }
}

int SendAllBytes(int socket, const char *buffer, size_t bytes_to_send)
{
    size_t total_bytes_sent = 0;
    while (bytes_to_send &gt; 0) {
        const ssize_t bytes_sent = send(socket, &amp;buffer[total_bytes_sent], bytes_to_send, 0);
        // Upon successful completion, send() shall return the number of bytes sent.
        // Otherwise, -1 shall be returned and errno set to indicate the error.
        // (Source: http://pubs.opengroup.org/onlinepubs/9699919799/).
        if (bytes_sent == -1) {
            // Error.
            return -1;
        }

        total_bytes_sent += bytes_sent;
        bytes_to_send -= bytes_sent;
    }
    return 0;
}
</code></pre>

<h1>Portability note</h1>

<p>Consider using ***<a href="https://en.wikipedia.org/wiki/C_data_types#Fixed-width_integer_types" rel="nofollow">fixed-width integer types</a> to enhance the portability. In the described case, the file size is not represented by the fixed-width integer type.</
