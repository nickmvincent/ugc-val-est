Answered posted on: 2013-11-29 12:33:13+00:00
<a<p>Yes, it is possible to do it with one server. But the caveat is that it works on clients that support ***<a href="http://en.wikipedia.org/wiki/Server_Name_Indication" rel="noreferrer">SNI</a> - which is most modern browsers. </p>

<p>This is how you do it:</p>

<pre><code>//function to pick out the key + certs dynamically based on the domain name
function getSecureContext (domain) {
    return crypto.createCredentials({
        key:  fs.readFileSync('/path/to/domain.key'),
        cert: fs.readFileSync('/path/to/domain.crt'),
        ca: [fs.readFileSync('/path/to/CA_cert_1.crt'), fs.readFileSync('/path/to/CA_cert_2.crt'), &lt;include all CA certs that you have to&gt; ... ]
      }).context;
}

//read them into memory
var secureContext = {
    'domain1': getSecureContext('domain1'),
    'domain2': getSecureContext('domain2'),
    .
    .
}

//provide a SNICallback when you create the options for the https server
var options = {
    SNICallback: function (domain) {
        return secureContext[domain];
    }, //SNICallback is passed the domain name, see NodeJS docs on TLS
    cert: fs.readFileSync('/path/to/server.crt'),
    key: fs.readFileSync('/path/to/server.key'),                
    }
}

//create your https server
var server = require('https').createServer(options, [requestListener]);
//using Express
var server = require('https').createServer(options, require('express')());
server.listen(&lt;someport&gt;);
</code></pre>

<p>This works because <a href="http://nodejs.org/api/https.html#https_https_createserver_options_requestlistener" rel="noreferrer">the options for https</a> is similar to tls.createServer(). Make sure you include all required CA intermediate and root certificates in the crypto.createCredentials call. Also if you have a CA bundle, split them up into multiple single crt files before using them as 'ca' accepts an array of certificates. </
